<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HttpInspector</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            background-color: #05070f;
            color: #f1f5ff;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top, rgba(59, 130, 246, 0.15), transparent 55%), #05070f;
        }

        .layout {
            padding: 2rem clamp(1rem, 4vw, 3.5rem);
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.9rem;
            margin: 0;
        }

        .header-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .controls input,
        .controls select,
        .controls button {
            padding: 0.75rem;
            border-radius: 0.65rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(15, 23, 42, 0.65);
            color: inherit;
            font-size: 0.95rem;
        }

        .refresh {
            cursor: pointer;
            border-color: rgba(96, 165, 250, 0.8);
            background: rgba(59, 130, 246, 0.2);
        }

        .log-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .log-card {
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 1.25rem;
            padding: 1.5rem;
            background: rgba(8, 13, 25, 0.95);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.65);
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            align-items: flex-start;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            padding-bottom: 0.75rem;
        }

        .title-left {
            flex: 1 1 auto;
        }

        .title-line {
            display: flex;
            gap: 0.6rem;
            align-items: center;
            flex-wrap: wrap;
            font-size: 1rem;
            font-weight: 600;
        }

        .path-text {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            background: rgba(31, 41, 55, 0.6);
            padding: 0.35rem 0.6rem;
            border-radius: 0.6rem;
            overflow-wrap: anywhere;
        }

        .copy-url-btn,
        .copy-btn,
        .copy-headers-btn {
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: transparent;
            color: inherit;
            border-radius: 0.55rem;
            padding: 0.3rem 0.8rem;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .status-pill {
            padding: 0.3rem 0.85rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .status-2xx { background: rgba(34, 197, 94, 0.25); color: #86efac; }
        .status-3xx { background: rgba(14, 165, 233, 0.25); color: #7dd3fc; }
        .status-4xx { background: rgba(249, 115, 22, 0.25); color: #fdba74; }
        .status-5xx { background: rgba(239, 68, 68, 0.25); color: #fca5a5; }
        .status-na  { background: rgba(148, 163, 184, 0.3); color: #cbd5f5; }

        .method-pill {
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .method-default { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .method-post { background: rgba(14, 165, 233, 0.2); color: #7dd3fc; }
        .method-put { background: rgba(249, 115, 22, 0.25); color: #fdba74; }
        .method-delete { background: rgba(239, 68, 68, 0.25); color: #fca5a5; }
        .method-patch { background: rgba(168, 85, 247, 0.25); color: #d8b4fe; }

        .mini-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.9rem 0 1rem;
        }

        .summary-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.65rem;
            border-radius: 0.6rem;
            background: rgba(148, 163, 184, 0.12);
            font-size: 0.85rem;
            color: rgba(226, 232, 240, 0.85);
        }

        .summary-item .icon {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .timeline {
            position: relative;
            background: rgba(148, 163, 184, 0.18);
            border-radius: 999px;
            height: 6px;
            margin-bottom: 1.1rem;
        }

        .timeline-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg, #38bdf8, #22d3ee, #a855f7);
        }

        .timeline-label {
            font-size: 0.82rem;
            margin-top: 0.4rem;
            color: rgba(226, 232, 240, 0.8);
        }

        .io-stack {
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 1rem;
            padding: 0.8rem;
            background: rgba(5, 8, 16, 0.9);
        }

        .io-stack-summary {
            font-size: 0.78rem;
            text-transform: uppercase;
            color: rgba(148, 163, 184, 0.8);
            cursor: pointer;
            margin-bottom: 0.6rem;
        }

        .section-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        details.section-wrapper {
            padding: 0.15rem 0.6rem 0.6rem;
            border-radius: 1rem;
            background: rgba(15, 23, 42, 0.85);
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.12);
        }

        .section-wrapper.request {
            background: rgba(15, 23, 42, 0.9);
        }

        .section-wrapper.response {
            background: rgba(10, 12, 22, 0.95);
        }

        .flow-indicator {
            text-align: center;
            font-size: 1rem;
            color: rgba(148, 163, 184, 0.35);
        }

        .section-title {
            font-size: 0.72rem;
            text-transform: uppercase;
            color: rgba(148, 163, 184, 0.8);
            padding-top: 0.2rem;
            padding-bottom: 0.2rem;
        }

        .section-divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.25);
            margin: 0.35rem 0;
        }

        .section-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .section-card {
            background: rgba(8, 13, 25, 0.95);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        .section-card.request-card {
            border-left: 4px solid rgba(59, 130, 246, 0.7);
        }

        .section-card.response-card.status-2xx { border-left: 4px solid rgba(34, 197, 94, 0.6); }
        .section-card.response-card.status-3xx { border-left: 4px solid rgba(14, 165, 233, 0.6); }
        .section-card.response-card.status-4xx { border-left: 4px solid rgba(249, 115, 22, 0.7); }
        .section-card.response-card.status-5xx { border-left: 4px solid rgba(239, 68, 68, 0.7); }
        .section-card.response-card.status-na { border-left: 4px solid rgba(148, 163, 184, 0.6); }

        .section-card header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            letter-spacing: 0.03em;
            margin-bottom: 0.6rem;
        }

        .headers-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 0.35rem 1rem;
            font-size: 0.88rem;
            overflow-wrap: anywhere;
        }

        .header-name {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            color: #94a3b8;
        }

        pre.body-block {
            background: rgba(2, 6, 23, 0.9);
            border-radius: 0.7rem;
            padding: 0.95rem;
            overflow-x: auto;
            font-size: 0.88rem;
            line-height: 1.45;
            min-height: 60px;
        }

        details.drawer {
            margin-top: 1.2rem;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            padding-top: 0.9rem;
        }

        details.drawer summary {
            cursor: pointer;
            font-weight: 600;
            color: rgba(226, 232, 240, 0.8);
        }

        .drawer-grid {
            margin-top: 0.7rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
        }

        .drawer-item {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .drawer-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: rgba(148, 163, 184, 0.7);
        }

        .drawer-value {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.85rem;
            background: rgba(15, 23, 42, 0.7);
            padding: 0.35rem 0.5rem;
            border-radius: 0.5rem;
        }

        .muted {
            color: rgba(226, 232, 240, 0.65);
        }

        @media (max-width: 640px) {
            .title-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .section-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-base-path="__HTTP_INSPECTOR_BASE__">
    <div class="layout">
        <div class="header-bar">
            <div>
                <h1>HttpInspector</h1>
                <p class="muted">Live HTTP request & response stream</p>
            </div>
            <button class="refresh" id="refreshButton">Refresh now</button>
        </div>
        <div class="controls">
            <input id="searchInput" type="text" placeholder="Search path, id, header" />
            <select id="methodFilter">
                <option value="">All methods</option>
                <option>GET</option>
                <option>POST</option>
                <option>PUT</option>
                <option>PATCH</option>
                <option>DELETE</option>
                <option>HEAD</option>
                <option>OPTIONS</option>
            </select>
            <select id="statusFilter">
                <option value="">All statuses</option>
                <option value="2">2xx Success</option>
                <option value="3">3xx Redirect</option>
                <option value="4">4xx Client</option>
                <option value="5">5xx Server</option>
            </select>
        </div>
        <div class="log-list" id="logList"></div>
    </div>
    <script>
        const state = {
            basePath: document.body.dataset.basePath,
            entries: new Map(),
            lastTimestamp: null,
            search: '',
            method: '',
            statusBucket: '',
            expandedIds: new Set()
        };
        const EMPTY_BODY = '[empty]';

        const list = document.getElementById('logList');
        const searchInput = document.getElementById('searchInput');
        const methodFilter = document.getElementById('methodFilter');
        const statusFilter = document.getElementById('statusFilter');
        const refreshButton = document.getElementById('refreshButton');

        searchInput.addEventListener('input', () => {
            state.search = searchInput.value.trim().toLowerCase();
            render();
        });
        methodFilter.addEventListener('change', () => {
            state.method = methodFilter.value;
            render();
        });
        statusFilter.addEventListener('change', () => {
            state.statusBucket = statusFilter.value;
            render();
        });
        refreshButton.addEventListener('click', fetchEvents);

        async function fetchEvents() {
            const url = new URL(window.location.origin + state.basePath + '/stream');
            if (state.lastTimestamp) {
                url.searchParams.set('since', state.lastTimestamp);
            }
            try {
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) {
                    return;
                }
                const payload = await response.json();
                if (Array.isArray(payload) && payload.length) {
                    for (const evt of payload) {
                        upsert(evt);
                        if (!state.lastTimestamp || evt.timestamp > state.lastTimestamp) {
                            state.lastTimestamp = evt.timestamp;
                        }
                    }
                    render();
                }
            } catch (err) {
                console.error('HttpInspector poll failed', err);
            }
        }

        function upsert(entry) {
            const id = entry.id;
            const existing = state.entries.get(id) ?? { id, request: null, response: null };
            if (entry.type === 'request') {
                existing.request = entry;
            } else {
                existing.response = entry;
            }
            state.entries.set(id, existing);
        }

        function render() {
            const fragments = [];
            const search = state.search;
            const method = state.method;
            const bucket = state.statusBucket;
            const items = Array.from(state.entries.values()).sort((a, b) => {
                const left = (a.response?.timestamp || a.request?.timestamp || '').localeCompare(
                    b.response?.timestamp || b.request?.timestamp || '');
                return -left;
            });

            for (const pair of items) {
                const request = pair.request;
                const response = pair.response;
                if (!request && !response) {
                    continue;
                }
                if (method && request?.method !== method) {
                    continue;
                }
                if (bucket && !matchesBucket(response, bucket)) {
                    continue;
                }
                if (search && !matchesSearch(request, response, search)) {
                    continue;
                }
                fragments.push(renderCard(pair));
            }

            list.innerHTML = fragments.join('') || '<p class="muted">No events captured yet.</p>';
            wireCopyButtons();
        }

        function renderCard(pair) {
            const request = pair.request;
            const response = pair.response;
            const status = response?.statusCode ?? '—';
            const statusClass = `status-${getStatusBucket(status)}`;
            const durationText = response?.durationMs != null ? `${response.durationMs.toFixed(2)} ms` : 'pending';
            const reqBodyId = `${pair.id}-req-body`;
            const resBodyId = `${pair.id}-res-body`;
            const shortId = trimId(pair.id);
            const fullPath = `${request?.path ?? ''}${request?.queryString ?? ''}` || '/';

            const timeline = renderTimeline(response?.durationMs);
            const requestRow = renderRow('REQUEST', 'request', request, reqBodyId, 'section-card request-card');
            const responseRow = renderRow('RESPONSE', 'response', response, resBodyId, `section-card response-card ${statusClass}`);
            const technicalDetails = renderTechnicalDetails(pair.id, request, response);

            return `
                <article class="log-card">
                    <div class="title-row">
                        <div class="title-left">
                            <div class="title-line">
                                ${renderMethodPill(request?.method)}
                                <span class="path-text" title="${escapeHtml(fullPath)}">${escapeHtml(fullPath)}</span>
                            </div>
                            <button class="copy-url-btn" type="button" data-copy-url="${encodeURIComponent(fullPath)}">Copy URL</button>
                        </div>
                        <span class="status-pill ${statusClass}">${status}</span>
                    </div>
                    <div class="mini-summary">
                        ${renderSummaryItem('🗓', formatTimestamp(request?.timestamp))}
                        ${renderSummaryItem('⏲', durationText)}
                        ${renderSummaryItem('📡', request?.remoteIp ?? 'unknown')}
                        ${renderSummaryItem('#', shortId.display, shortId.full)}
                    </div>
                    ${timeline}
                    <details class="io-stack" closed>
                        <summary class="io-stack-summary">Details</summary>
                        <div class="section-grid">
                            ${requestRow}
                            ${responseRow}
                        </div>
                        ${technicalDetails}
                    </details>
                </article>
            `;
        }

        function renderRow(label, type, entry, bodyId, cardClass) {
            const headersCard = renderSection('Headers', renderHeaders(entry?.headers), `${cardClass}` , type, entry?.headers);
            const bodyCard = renderBodySection('Body', bodyId, entry?.body, cardClass);
            return `
                <details class="section-wrapper ${type}" open>
                    <summary class="section-title">${label}</summary>
                    <div class="section-divider"></div>
                    <div class="section-row">
                        ${headersCard}
                        ${bodyCard}
                    </div>
                </details>
            `;
        }

        function renderTimeline(durationMs) {
            if (!durationMs || Number.isNaN(durationMs)) {
                return '';
            }
            const width = Math.min(Math.max((Math.min(durationMs, 5000) / 5000) * 100, 6), 100);
            return `
                <div>
                    <div class="timeline">
                        <div class="timeline-bar" style="width:${width}%"></div>
                    </div>
                    <div class="timeline-label">Duration ${durationMs.toFixed(2)} ms</div>
                </div>
            `;
        }

        function renderSection(title, contentHtml, cardClass, type, headers) {
            const copyBtn = headers && Object.keys(headers).length
                ? `<button class="copy-headers-btn" type="button" data-copy-headers='${JSON.stringify(headers)}'>Copy All</button>`
                : '';
            return `
                <div class="${cardClass}">
                    <header>${title}${copyBtn}</header>
                    ${contentHtml || '<p class="muted">None</p>'}
                </div>
            `;
        }

        function renderBodySection(title, bodyId, body, cardClass) {
            return `
                <div class="${cardClass}">
                    <header>${title}<button class="copy-btn" type="button" data-copy-body="${bodyId}">Copy</button></header>
                    <pre id="${bodyId}" class="body-block" data-body="${encodeBody(body)}"></pre>
                </div>
            `;
        }

        function renderTechnicalDetails(entryId, request, response) {
            const headers = request?.headers ?? {};
            const pairs = [
                ['User-Agent', getHeaderValue(headers, 'User-Agent')],
                ['Referer', getHeaderValue(headers, 'Referer')],
                ['Host', getHeaderValue(headers, 'Host')],
                ['sec-ch-ua', getHeaderValue(headers, 'sec-ch-ua')],
                ['Accept-Encoding', getHeaderValue(headers, 'Accept-Encoding')],
                ['Priority', getHeaderValue(headers, 'Priority')],
                ['Accept', getHeaderValue(headers, 'Accept')],
                ['Content-Type', getHeaderValue(headers, 'Content-Type')],
                ['Response-Length', response?.headers?.['Content-Length']]
            ].filter(([, value]) => value);

            if (!pairs.length) {
                return '';
            }

            const grid = pairs.map(([label, value]) => `
                <div class="drawer-item">
                    <span class="drawer-label">${escapeHtml(label)}</span>
                    <span class="drawer-value">${escapeHtml(value)}</span>
                </div>
            `).join('');

            return `
                <details class="drawer">
                    <summary>More Details</summary>
                    <div class="drawer-grid">${grid}</div>
                </details>
            `;
        }

        function renderMethodPill(method) {
            const normalized = (method || 'GET').toUpperCase();
            const classMap = {
                GET: 'method-default',
                POST: 'method-post',
                PUT: 'method-put',
                DELETE: 'method-delete',
                PATCH: 'method-patch'
            };
            const methodClass = classMap[normalized] || 'method-default';
            return `<span class="method-pill ${methodClass}">${escapeHtml(normalized)}</span>`;
        }

        function renderSummaryItem(icon, value, fullValue) {
            const titleAttr = fullValue ? `title="${escapeHtml(fullValue)}"` : '';
            return `<span class="summary-item" ${titleAttr}><span class="icon">${icon}</span>${escapeHtml(value ?? '-')}</span>`;
        }

        function renderHeaders(headers) {
            const entries = headers ? Object.entries(headers) : [];
            if (!entries.length) {
                return '<p class="muted">None</p>';
            }
            return `
                <div class="headers-grid">
                    ${entries.map(([key, value]) => `
                        <span class="header-name">${escapeHtml(key)}</span>
                        <span>${escapeHtml(value)}</span>
                    `).join('')}
                </div>
            `;
        }

        function matchesSearch(request, response, term) {
            const haystack = [request?.path, request?.queryString, request?.method, request?.id, response?.statusCode]
                .concat(Object.entries(request?.headers ?? {}))
                .concat(Object.entries(response?.headers ?? {}))
                .map(x => Array.isArray(x) ? x.join(':') : x ?? '')
                .join(' ')
                .toLowerCase();
            return haystack.includes(term);
        }

        function matchesBucket(response, bucket) {
            if (!response?.statusCode) {
                return false;
            }
            return getStatusBucket(response.statusCode) === `${bucket}xx`;
        }

        function getStatusBucket(status) {
            if (typeof status !== 'number') {
                return 'na';
            }
            const bucket = Math.floor(status / 100);
            return `${bucket}xx`;
        }

        function formatTimestamp(value) {
            if (!value) {
                return '-';
            }
            try {
                return new Date(value).toLocaleString();
            } catch {
                return value;
            }
        }

        function trimId(value) {
            if (!value) {
                return { display: '-', full: null };
            }
            if (value.length <= 14) {
                return { display: value, full: null };
            }
            return { display: `${value.slice(0, 11)}...`, full: value };
        }

        function getHeaderValue(headers, key) {
            if (!headers || !key) {
                return undefined;
            }
            const entry = Object.entries(headers).find(([header]) => header.toLowerCase() === key.toLowerCase());
            return entry ? entry[1] : undefined;
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function encodeBody(body) {
            if (!body) {
                return '';
            }
            return encodeURIComponent(body);
        }

        function formatBodyText(raw) {
            if (raw == null) {
                return EMPTY_BODY;
            }
            const trimmed = raw.trim();
            if (!trimmed || trimmed === '""') {
                return EMPTY_BODY;
            }
            try {
                const parsed = JSON.parse(trimmed);
                if (typeof parsed === 'string') {
                    return parsed.length ? parsed : EMPTY_BODY;
                }
                return JSON.stringify(parsed, null, 2);
            } catch {
                return trimmed;
            }
        }

        function hydrateBodies() {
            list.querySelectorAll('pre[data-body]').forEach(pre => {
                const encoded = pre.dataset.body;
                if (!encoded) {
                    pre.textContent = EMPTY_BODY;
                    return;
                }
                const decoded = decodeURIComponent(encoded);
                pre.textContent = formatBodyText(decoded);
            });
        }

        function wireCopyButtons() {
            hydrateBodies();
            list.querySelectorAll('[data-copy-body]').forEach(button => {
                button.addEventListener('click', async () => {
                    const targetId = button.getAttribute('data-copy-body');
                    const target = document.getElementById(targetId);
                    if (!target) {
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(target.textContent ?? '');
                        button.textContent = 'Copied!';
                        setTimeout(() => (button.textContent = 'Copy'), 1500);
                    } catch {
                        button.textContent = 'Failed';
                        setTimeout(() => (button.textContent = 'Copy'), 1500);
                    }
                });
            });

            list.querySelectorAll('[data-copy-url]').forEach(button => {
                button.addEventListener('click', async () => {
                    const encoded = button.getAttribute('data-copy-url');
                    const url = decodeURIComponent(encoded ?? '');
                    try {
                        await navigator.clipboard.writeText(url);
                        button.textContent = 'Copied';
                        setTimeout(() => (button.textContent = 'Copy URL'), 1500);
                    } catch {
                        button.textContent = 'Failed';
                        setTimeout(() => (button.textContent = 'Copy URL'), 1500);
                    }
                });
            });

            list.querySelectorAll('[data-copy-headers]').forEach(button => {
                button.addEventListener('click', async () => {
                    const payload = button.getAttribute('data-copy-headers');
                    try {
                        const parsed = JSON.parse(payload);
                        const text = Object.entries(parsed).map(([k, v]) => `${k}: ${v}`).join('\n');
                        await navigator.clipboard.writeText(text);
                        button.textContent = 'Copied!';
                        setTimeout(() => (button.textContent = 'Copy All'), 1500);
                    } catch {
                        button.textContent = 'Failed';
                        setTimeout(() => (button.textContent = 'Copy All'), 1500);
                    }
                });
            });
        }

        window.setInterval(fetchEvents, 4000);
        fetchEvents();
    </script>
</body>
</html>
