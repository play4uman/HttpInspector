<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HttpInspector</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            background-color: #0f1115;
            color: #f1f5f9;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: #0f1115;
            color: #f8fafc;
        }

        .layout {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 1.25rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .controls input,
        .controls select {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            background: #1e293b;
            color: inherit;
        }

        .log-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .log-card {
            border-radius: 0.75rem;
            border: 1px solid #1e293b;
            background: #111827;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.45);
        }

        .log-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .log-header strong {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            letter-spacing: 0.03em;
        }

        .status-pill {
            padding: 0.25rem 0.65rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .status-2xx { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .status-3xx { background: rgba(14, 165, 233, 0.15); color: #38bdf8; }
        .status-4xx { background: rgba(249, 115, 22, 0.15); color: #fb923c; }
        .status-5xx { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .status-na  { background: rgba(148, 163, 184, 0.2); color: #cbd5f5; }

        details {
            margin-top: 0.75rem;
            border-top: 1px solid #1e293b;
            padding-top: 0.75rem;
        }

        summary {
            cursor: pointer;
            font-weight: 600;
        }

        .json-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 0.75rem;
        }

        pre {
            margin: 0;
            padding: 0.85rem;
            border-radius: 0.5rem;
            background: #0f172a;
            overflow-x: auto;
            font-size: 0.85rem;
        }

        .muted {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        button.refresh {
            padding: 0.5rem 0.9rem;
            border-radius: 999px;
            border: 1px solid #334155;
            background: transparent;
            color: inherit;
            cursor: pointer;
        }

        .grid-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body data-base-path="__HTTP_INSPECTOR_BASE__">
    <div class="layout">
        <div class="log-header" style="margin-bottom: 1rem;">
            <div>
                <h1 style="margin:0">HttpInspector</h1>
                <p class="muted" style="margin:0.15rem 0 0">Streaming HTTP request and response logs.</p>
            </div>
            <button class="refresh" id="refreshButton">Refresh now</button>
        </div>
        <div class="controls">
            <input id="searchInput" type="text" placeholder="Search path, id, or header" />
            <select id="methodFilter">
                <option value="">All methods</option>
                <option>GET</option>
                <option>POST</option>
                <option>PUT</option>
                <option>PATCH</option>
                <option>DELETE</option>
                <option>HEAD</option>
                <option>OPTIONS</option>
            </select>
            <select id="statusFilter">
                <option value="">All statuses</option>
                <option value="2">2xx Success</option>
                <option value="3">3xx Redirect</option>
                <option value="4">4xx Client</option>
                <option value="5">5xx Server</option>
            </select>
        </div>
        <div class="log-list" id="logList"></div>
    </div>
    <script>
        const state = {
            basePath: document.body.dataset.basePath,
            entries: new Map(),
            lastTimestamp: null,
            search: '',
            method: '',
            statusBucket: '',
            expandedIds: new Set()
        };

        const list = document.getElementById('logList');
        const searchInput = document.getElementById('searchInput');
        const methodFilter = document.getElementById('methodFilter');
        const statusFilter = document.getElementById('statusFilter');
        const refreshButton = document.getElementById('refreshButton');

        searchInput.addEventListener('input', () => {
            state.search = searchInput.value.trim().toLowerCase();
            render();
        });
        methodFilter.addEventListener('change', () => {
            state.method = methodFilter.value;
            render();
        });
        statusFilter.addEventListener('change', () => {
            state.statusBucket = statusFilter.value;
            render();
        });
        refreshButton.addEventListener('click', fetchEvents);

        async function fetchEvents() {
            const url = new URL(window.location.origin + state.basePath + '/stream');
            if (state.lastTimestamp) {
                url.searchParams.set('since', state.lastTimestamp);
            }

            try {
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) {
                    return;
                }

                const payload = await response.json();
                if (Array.isArray(payload) && payload.length) {
                    for (const evt of payload) {
                        upsert(evt);
                        if (!state.lastTimestamp || evt.timestamp > state.lastTimestamp) {
                            state.lastTimestamp = evt.timestamp;
                        }
                    }
                    render();
                }
            } catch (err) {
                console.error('HttpInspector poll failed', err);
            }
        }

        function upsert(entry) {
            const id = entry.id;
            const existing = state.entries.get(id) ?? { id, request: null, response: null };
            if (entry.type === 'request') {
                existing.request = entry;
            } else {
                existing.response = entry;
            }
            state.entries.set(id, existing);
        }

        function render() {
            const fragments = [];
            const search = state.search;
            const method = state.method;
            const bucket = state.statusBucket;
            const items = Array.from(state.entries.values()).sort((a, b) => {
                const left = (a.response?.timestamp || a.request?.timestamp || '').localeCompare(
                    b.response?.timestamp || b.request?.timestamp || '');
                return -left;
            });

            for (const pair of items) {
                const request = pair.request;
                const response = pair.response;
                if (!request && !response) {
                    continue;
                }

                if (method && request?.method !== method) {
                    continue;
                }

                if (search && !matchesSearch(request, response, search)) {
                    continue;
                }

                if (bucket && !matchesBucket(response, bucket)) {
                    continue;
                }

                const status = response?.statusCode ?? '—';
                const statusClass = `status-${getStatusBucket(status)}`;
                const duration = response?.durationMs != null ? `${response.durationMs.toFixed(2)} ms` : 'pending';
                const openAttr = state.expandedIds.has(pair.id) ? ' open' : '';
                const row = `
                    <article class="log-card">
                        <div class="log-header">
                            <div>
                                <strong>${escapeHtml(request?.method ?? 'N/A')} ${escapeHtml(request?.path ?? '')}</strong>
                                <div class="muted">${escapeHtml(request?.queryString ?? '')}</div>
                            </div>
                            <div>
                                <span class="status-pill ${statusClass}">${status}</span>
                                <div class="muted" style="text-align:right">${duration}</div>
                            </div>
                        </div>
                        <div class="grid-meta">
                            <span>ID ${escapeHtml(pair.id)}</span>
                            <span>Remote ${escapeHtml(request?.remoteIp ?? 'unknown')}</span>
                            <span>${escapeHtml(response?.timestamp ?? request?.timestamp ?? '')}</span>
                        </div>
                        <details data-entry-id="${pair.id}"${openAttr}>
                            <summary>Details</summary>
                            <div class="json-grid">
                                <div>
                                    <h4>Request</h4>
                                    <pre>${formatJson(request)}</pre>
                                </div>
                                <div>
                                    <h4>Response</h4>
                                    <pre>${formatJson(response)}</pre>
                                </div>
                            </div>
                        </details>
                    </article>
                `;
                fragments.push(row);
            }

            list.innerHTML = fragments.join('') || '<p class="muted">No events captured yet.</p>';
            wireDetailsHandlers();
        }

        function wireDetailsHandlers() {
            list.querySelectorAll('details[data-entry-id]').forEach(details => {
                const id = details.dataset.entryId;
                if (!id) {
                    return;
                }
                details.addEventListener('toggle', () => {
                    if (details.open) {
                        state.expandedIds.add(id);
                    } else {
                        state.expandedIds.delete(id);
                    }
                });
            });
        }

        function matchesSearch(request, response, term) {
            const haystack = [request?.path, request?.queryString, request?.method, request?.id, response?.statusCode]
                .concat(Object.entries(request?.headers ?? {})).concat(Object.entries(response?.headers ?? {}))
                .map(x => Array.isArray(x) ? x.join(':') : x ?? '')
                .join(' ')
                .toLowerCase();
            return haystack.includes(term);
        }

        function matchesBucket(response, bucket) {
            if (!response?.statusCode) {
                return false;
            }
            return getStatusBucket(response.statusCode) === `${bucket}xx`;
        }

        function getStatusBucket(status) {
            if (typeof status !== 'number') {
                return 'na';
            }
            const bucket = Math.floor(status / 100);
            return `${bucket}xx`;
        }

        function formatJson(payload) {
            if (!payload) {
                return 'Ø';
            }
            try {
                return escapeHtml(JSON.stringify(payload, null, 2));
            } catch {
                return escapeHtml(String(payload));
            }
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        window.setInterval(fetchEvents, 4000);
        fetchEvents();
    </script>
</body>
</html>
